#!/bin/bash
#This file is an INCLUDE to pimpupdate. not to be run on its own under normal circumstances.

function doinstall.neoscrypt() {
	$THELINE
	echo "Neoscrypt profile and sgminer5 updater for pimp 1.5.6/1.6/1.7"
	echo "Note: IF you overwrite cgminer.nhmulti.conf/cgminer.whmulti.conf during this installation, you will need to run changebtcaddress again to update the config files with your btc address."
	echo "Continuing in 5 seconds, CTRL+C to abort."
	sleep 5
	$THELINE
	echo "PiMP $PIMP_VERSION detected, Continuing installation."
	echo "Checking for existing files."
    checkinstall.conffile /opt/ifmi/cgminer.neoscrypt.conf cgminer.neoscrypt.conf $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/cgminer.neoscrypt.conf.tbz2
    checkinstall.conffile /opt/ifmi/cgminer.nhmulti.conf cgminer.nhmulti.conf $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/cgminer.nhmulti.conf.tbz2
    checkinstall.conffile /opt/ifmi/cgminer.whmulti.conf cgminer.whmulti.conf $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/cgminer.whmulti.conf.tbz2
	echo "Downloading Neoscrypt profiles for poolmanager..."	
	case $PIMP_VERSION in 
	1.5.6-amd-13.12 | 1.5.6-amd-14.4 | 1.5.6-amd-14.6 )
		#Download poolmanager conf for 1.5.6
		download /tmp/poolmanager.conf.neoscrypt.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/poolmanager.conf.neoscrypt.1.5.6.tbz2
	;;
	1.4.8-amd-13.12 | 1.4.9-amd-13.12 | 1.6.0-amd-13.12 | 1.7.0-amd-13.12 )
    	download /tmp/poolmanager.conf.neoscrypt.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/poolmanager.conf.neoscrypt.1.6.0-13.12.tbz2
    ;; 
	1.4.8-amd-14.4 | 1.4.8-amd-14.6 | 1.4.9-amd-14.4 | 1.4.9-amd-14.6 | 1.7.0-amd-14.6 | 1.7.0-amd-14.9 | 1.6.0-amd-14.6 | 1.6.0-amd-14.9 | 1.5.61-amd-14.6 | 1.5.61-amd-14.9 | 1.5.62-amd-14.6 | 1.5.62-amd-14.9 )
		download /tmp/poolmanager.conf.neoscrypt.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/poolmanager.conf.neoscrypt.1.6.0-14.6.tbz2
	;;
	esac
	echo "Backing up old poolmanager.conf to $BACKUPDIR"
	cp /opt/ifmi/poolmanager.conf $BACKUPDIR/poolmanager.conf.$DATESTAMP
	echo "Download finished, extracting...."
	tar xvjpf /tmp/poolmanager.conf.neoscrypt.tbz2 -C /opt/ifmi/
	chown -R www-data.root /opt/ifmi/poolmanager.conf
	echo "New poolmanager profile installed, continuing installation.."
	doinstall.neoscrypt.upgsg5
}

function doinstall.neoscrypt.upgsg5() {
	echo "Preparing to upgrade sgminer5-develop"
 	case $PIMP_VERSION2 in 
 	1.5.6-amd | 1.5.61-amd | 1.5.62-amd )
		echo "Downloading SGMiner5-develop for pimp 1.5.6/1.6.0/32bit..."
	    download /tmp/sgminer5-develop.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/sgminer5-develop.i386.tbz2
	    echo "Download finished, removing old sgminer5 and extracting replacement...."
	    rm -rf /opt/sgminer5
	;; uptim
	1.6.0-amd )
		echo "Downloading SGMiner5-develop for pimp 1.5.6/1.6.0/32bit..."
	    download /tmp/sgminer5-develop.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/sgminer5-develop.i386.tbz2
	    echo "Download finished, removing old sgminer5-develop and extracting replacement...."
	    rm -rf /opt/sgminer5-develop
	;;
	1.4.8-amd | 1.4.9-amd | 1.7.0-amd | 1.5.6-amd | 1.5.61-amd | 1.5.62-amd | 1.6.0-amd )
		echo "Downloading SGMiner5-develop for pimp 1.7.0/64bit..."
	    download /tmp/sgminer5-develop.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/sgminer5-develop.amd64.tbz2
	    echo "Download finished, removing old sgminer5-develop and extracting replacement...."
	    rm -rf /opt/sgminer5-develop
	;;
	esac
    tar xjpf /tmp/sgminer5-develop.tbz2 -C /opt/
    echo "Done extracting, restarting mining... Remember to use poolmanager profiles ending in -develop!"
    f.minestart
    echo "Installation finished, Enjoy!"
}


#function doinstall.neoscrypt.upgsg5nope.jpg() {
#	case $PIMP_VERSION2 in 
#	1.5.6-amd )
#	    MINERDIRNAME2="/opt/sgminer5-develop"
#	;;
#	1.5.61-amd | 1.5.62-amd | 1.6.0-amd )
#		MINERDIRNAME2="/opt/sgminer5-develop"
#	;;
#	1.4.8-amd | 1.4.9-amd | 1.7.0-amd )
#		MINERDIRNAME2="/opt/sgminer5-develop"
#	;;
#	esac
#	MINERNAME="Sgminer"
#	MINERVER="This gets set in the script"
#	MINERDIRNAME="sgminer5-develop"
#	MINERDIRNAME2="/opt/sgminer5-develop"
#	MINEREXECNAME="sgminer"
#	MINERUSELSOC="yes"
#	MINERCONFIGFLAGS=" "
#	MINERCONFIGCOMMAND="configure"
#	MINERGETMETHOD="git"
#	MINERGETFLAGS="clone -b develop"
#   MINERGETURL="https://github.com/sgminer-dev/sgminer.git"
#	buildminer.2
#}

#Not sure if any of this is needed other than the first one.
#	if [ -f /opt/ifmi/cgminer.neoscrypt.conf ]; #NEOIF1
#		then
#		echo "Warning: Previous installation of neoscrypt addition detected, do you wish to continue?"
#		read NEOSCRYPT_REINSTALL
#			if [ $NEOSCRYPT_REINSTALL = y ]; #NEOIF2
#				then  
#				echo "Do you wish reinstall the default cgminer.neoscrypt.conf? (No keeps your existing configuration file intact. (Y/N)?"
#					read NEOSCRYPT_CONF_OVERWRITE
#					if [ $NEOSCRYPT_CONF_OVERWRITE = y]; #NEOIF3
#						then
#						cp /opt/ifmi/cgminer.neoscrypt.conf /root/cgminer.neoscrypt.conf.bak
#						doinstall.neoscrypt.2
#					else
#					doinstall.neoscrypt.3
#					fi #NEOFI3
#				f.minestop
#				doinstall.neoscrypt.2
#			else
#			f.return
#			fi #NEOFI2
#		else
#			doinstall.neoscrypt.2
#		fi #NEOFI1
#End removable section.


#function doinstall.neoscrypt.2() {
#	echo "Downloading neoscrypt profiles for poolmanager..."
#download /tmp/neoscrypt.profiles.tbz2 $UPDATESERVER/pimpupdate/1.6-1.7-neoscrypt/neoscrypt.profiles.tbz2#
#	echo "Download finished, extracting...."
#}